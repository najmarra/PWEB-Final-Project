<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Latihan Soal</title>

<!-- FONTS -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- BOOTSTRAP & ICON -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root{
  --green:#6D9773;
  --dark:#0C3B2E;
  --brown:#BB8A52;
  --yellow:#FFBA00;
  --muted:#6b7280;
  --glass:rgba(255,255,255,.9);
  --border:#eee;
}

/* FULL COVER */
html,body{
  height:100%;
  margin:0;
  overflow:hidden;
  font-family:'Roboto',system-ui,Arial;
  background:var(--dark);
}

/* CONTAINER UTAMA */
.cover{
  width:95vw;
  height:96vh;
  margin:2vh auto;
  background:var(--glass);
  border-radius:18px;
  padding:20px;
  display:flex;
  gap:20px;
  box-shadow:0 18px 50px rgba(12,59,46,.08);
  box-sizing:border-box;
}

/* SIDEBAR */
.sidebar{
  width:240px;
  display:flex;
  flex-direction:column;
  gap:14px;
  flex-shrink:0;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.logo{
  width:44px;
  height:44px;
  border-radius:10px;
  background:linear-gradient(135deg,var(--green),var(--brown));
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}
.navlink{
  padding:10px 12px;
  border-radius:10px;
  display:flex;
  gap:12px;
  align-items:center;
  cursor:pointer;
  color:var(--muted);
}
.navlink i{color:var(--green)}
.navlink.active{
  background:rgba(109,151,115,.15);
  color:var(--dark);
  font-weight:600;
}
.quick-card{
  margin-top:auto;
  background:#fff;
  border-radius:12px;
  padding:12px;
  text-align:center;
}

/* MAIN */
.main{
  flex:1;
  display:flex;
  flex-direction:column;
  min-width:0;
}

/* CONTENT (SCROLL DI SINI) */
.content{
  flex:1;
  overflow-y:auto;
  padding-right:6px;
}

/* CARD */
.card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.04);
}

/* QUIZ */
.option{
  padding:12px;
  border:1px solid #eee;
  border-radius:10px;
  cursor:pointer;
  margin-bottom:10px;
}
.option:hover{
  background:#f5f7f6;
}
.option.active{
  background:#e6f2ee;
  border-color:var(--green);
}

.progress{
  height:10px;
  border-radius:20px;
}

#timerCard{
  background:#fff3cd;
  border-left:6px solid #ffba00;
}

.quiz-wrapper{
  background:#fff;
  border-radius:16px;
  padding:24px;
}

/* HEADER */
.quiz-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.quiz-header h4{margin-bottom:8px}

.progress{
  height:8px;
  background:#eee;
  border-radius:10px;
}
.progress-bar{
  height:100%;
  background:#0d6efd;
  width:0%;
  border-radius:10px;
}

/* SCORE */
.score-box{
  background:#f1f7ff;
  padding:14px;
  border-radius:12px;
  text-align:center;
}
.score-box strong{
  font-size:22px;
}

/* BODY */
.quiz-body{
  display:flex;
  gap:24px;
}

/* LEFT */
.quiz-left{
  flex:3;
}

/* OPTIONS */
.option{
  padding:14px;
  border:1px solid #ddd;
  border-radius:12px;
  margin-bottom:12px;
  cursor:pointer;
}
.option.active{
  border-color:#0d6efd;
  background:#eef5ff;
  font-weight:600;
}

/* NAV */
.quiz-nav{
  display:flex;
  justify-content:space-between;
  margin-top:20px;
}

/* RIGHT */
.quiz-right{
  flex:1;
}

.timer-card{
  background:#fff3cd;
  border-radius:12px;
  padding:14px;
  text-align:center;
}

#timeLeft{
  font-size:24px;
  font-weight:700;
  color:#dc3545;
}

/* QUESTION LIST */
.question-list{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.question-list div{
  background:#ffffff;
  border-radius:10px;
  padding:10px;
  font-size:14px;
  border:1px solid #e5e7eb;
}

.question-list .active{
  background:#e7f1ff;
  font-weight:600;
}

.question-box{
  background:#4FB6A3;
  border-radius:16px;
  padding:20px;
  border:1px solid #e5e7eb;
}

.question-header{
  background:#ffffff;
  border-radius:12px;
  padding:14px 16px;
  margin-bottom:16px;
  border:1px solid #e5e7eb;
}

.question-header h5{
  margin:6px 0 0;
  font-weight:600;
}

.side-panel{
  background:#f8fafc;
  border-radius:16px;
  padding:16px;
  border:1px solid #e5e7eb;
  display:flex;
  flex-direction:column;
  gap:16px;
}

/* SUMMARY WRAPPER */
.summary-wrapper{
  width:100%;
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  border-radius:14px;
  background:linear-gradient(135deg,#5f2c82,#7f53ac);
}

/* SUMMARY CARD */
.summary-card{
  background:#fff;
  border-radius:24px;
  padding:32px;
  width:420px;
  text-align:center;
  box-shadow:0 20px 40px rgba(0,0,0,.2);
}

/* TROPHY */
.trophy{
  font-size:64px;
  margin-bottom:12px;
}

/* TITLE */
.summary-card h2{
  font-weight:700;
  margin-bottom:6px;
}

/* SCORE TEXT */
.score-text{
  color:#6b7280;
  margin-bottom:24px;
}
.score-text span{
  color:#22c55e;
  font-weight:700;
}

/* STATS */
.summary-stats{
  display:flex;
  justify-content:space-between;
  margin-top:20px;
}

.stat{
  flex:1;
  text-align:center;
}

.stat strong{
  display:block;
  font-size:20px;
  margin-top:6px;
}

.stat small{
  color:#6b7280;
}

/* ICON */
.icon{
  width:36px;
  height:36px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  font-weight:700;
  color:#fff;
}

.icon.purple{background:#8b5cf6}
.icon.green{background:#22c55e}
.icon.red{background:#ef4444}

/* ANSWER KEY PAGE */
.answer-key-wrapper{
  width:88%;
  max-width:1000px;
  margin:0 auto;
  background:#fff;
  border-radius:18px;
  padding:24px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
}

.answerkey-card{
  background:#fff;
  width:700px;
  max-height:90vh;
  overflow-y:auto;
  border-radius:20px;
  padding:24px;
}

/* XP BAR */
.xp-box{
  margin:20px 0;
}

.xp-label{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin-bottom:6px;
}

.xp-bar{
  display:flex;
  height:18px;
  border-radius:12px;
  overflow:hidden;
  background:#e5e7eb;
}

#xpCorrect, #xpWrong{
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  font-weight:600;
  color:#fff;
  white-space:nowrap;
}

#xpCorrect{
  background:#22c55e;
  width:0%;
}

#xpWrong{
  background:#ef4444;
  width:0%;
}

.xp-legend{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-top:6px;
}

.legend-correct{color:#16a34a}
.legend-wrong{color:#dc2626}

/* ANSWER ITEM */
.answer-item{
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
}

.answer-item.correct{
  background:#dcfce7;
  border-left:6px solid #22c55e;
}

.answer-item.wrong{
  background:#fee2e2;
  border-left:6px solid #ef4444;
}

.answer-item strong{
  display:block;
  margin-bottom:6px;
}
.summary-actions{
  display:flex;
  gap:12px;
  justify-content:center;
  margin-top:20px;
}

</style>
</head>

<body>

<div class="cover">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">Logo</div>
      <strong>NAMA BIMBEL</strong>
    </div>

    <div class="navlink" onclick="location.href='dashboard.html'">
      <i class="bi bi-speedometer2"></i>Dashboard
    </div>
    <div class="navlink" onclick="location.href='kelas.html'">
      <i class="bi bi-people-fill"></i>Daftar Kelas
    </div>
    <div class="navlink" onclick="location.href='materi.html'">
      <i class="bi bi-journal-bookmark"></i>Materi Belajar
    </div>
    <div class="navlink" onclick="location.href='quiz.html'">
      <i class="bi bi-calendar2-event"></i>Latihan Soal
    </div>
    <div class="navlink" onclick="location.href='LaporanSiswa.html'">
        <i class="bi bi-graph-up"></i>Laporan Siswa
      </div>
    <div class="navlink" onclick="location.href='setting.html'">
      <i class="bi bi-gear-fill"></i>Pengaturan
    </div>

    <div class="quick-card">
      <strong>Quick Actions</strong>
      <button class="btn btn-sm mt-2" style="background:var(--green);color:#fff">
        üìù Lanjutkan Belajar
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- PILIH PAKET -->
    <div id="menuQuiz" class="card">
      <h5 class="mb-3">Pilih Latihan Soal</h5>
      <div id="quizMenuRow" class="row"></div>
    </div>


    <!-- QUIZ (AWALNYA HIDDEN) -->
    <div id="quizPage" class="quiz-wrapper" style="display:none">

    <!-- HEADER -->
    <div class="quiz-header">
        <div>
        <h4 id="quizTitle"></h4>
        <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        </div>

        <div class="score-box">
        <strong id="scorePercent">0%</strong>
        <span>Jawaban benar</span>
        </div>
    </div>

    <!-- BODY -->
    <div class="quiz-body">

        <!-- KIRI -->
        <div class="quiz-left">
          <div class="question-box">
            <div class="question-header">
              <small id="questionCount"></small>
              <h5 id="questionText"></h5>
            </div>
            <div id="options"></div>
          </div>
          <div class="quiz-nav">
            <button class="btn btn-outline-secondary" onclick="prevQuestion()">Previous</button>
            <button class="btn btn-primary" onclick="nextQuestion()">Next</button>
          </div>
        </div>

        <!-- KANAN -->
        <div class="quiz-right">
          <div class="side-panel">
            <div class="timer-card">
              <strong>Waktu</strong>
              <div id="timeLeft">00:28</div>
            </div>
            <div id="questionList" class="question-list"></div>
          </div>
        </div>
    </div>

    <div id="summaryPage" class="summary-wrapper" style="display:none">

    <div class="summary-card">

      <!-- TROPHY -->
      <div class="trophy">
        üèÜ
      </div>

      <h2>Congratulations!</h2>
      <p class="score-text">
        Kamu mendapatkan <span id="sumScore">0</span> poin
      </p>

      <!-- STATS -->
      <div class="summary-stats">
        <div class="stat">
          <span class="icon purple">Q</span>
          <strong id="sumTotal">0</strong>
          <small>Total Soal</small>
        </div>

        <div class="stat">
          <span class="icon green">‚úî</span>
          <strong id="sumCorrect">0</strong>
          <small>Benar</small>
        </div>

        <div class="stat">
          <span class="icon red">‚úñ</span>
          <strong id="sumWrong">0</strong>
          <small>Salah</small>
        </div>
      </div>

    <div class="summary-actions">
      <button class="btn btn-primary" onclick="location.reload()">
        Main Lagi
      </button>

      <button class="btn btn-outline-success" onclick="openAnswerKey()">
        Kunci
      </button>
    </div>
    </div>
  </div>
  <div id="answerKeyPage" class="answerkey-wrapper" style="display:none">

  <div class="answerkey-card">

    <h3>Kunci Jawaban</h3>

    <!-- XP BAR -->
    <div class="xp-box">
    <div class="xp-bar">
      <div id="xpCorrect">
        <span id="xpCorrectText"></span>
      </div>
      <div id="xpWrong">
        <span id="xpWrongText"></span>
      </div>
    </div>

    <div class="xp-legend">
      <span class="legend-correct">‚úî Benar</span>
      <span class="legend-wrong">‚úñ Salah</span>
    </div>
  </div>

    <!-- LIST SOAL -->
    <div id="answerKeyList"></div>

    <button class="btn btn-secondary mt-4" onclick="backToSummary()">Summary </button>
  </div>
</div>
  </main>
</div>

<script>
let questions = [];
let currentSubBab = "";
let index=0;
let answers=[];
let time=60;
let timer;
let quizFinished=false;

const nextBtn = document.querySelector('.quiz-nav .btn.btn-primary');

const summaryPage = document.getElementById('summaryPage');
const sumTotal = document.getElementById('sumTotal');
const sumCorrect = document.getElementById('sumCorrect');
const sumWrong = document.getElementById('sumWrong');
const sumBar = document.getElementById('sumBar');
const answerReview = document.getElementById('answerReview');

fetch("../api/quiz_paket.php")
  .then(res => {
    if(!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  })
  .then(data => {
    console.log("PAKET QUIZ:", data);

    const row = document.getElementById("quizMenuRow");
    row.innerHTML = "";

    if (data.length === 0) {
      row.innerHTML = `<p class="text-muted">Belum ada latihan soal</p>`;
      return;
    }

    data.forEach(p => {
      row.innerHTML += `
        <div class="col-md-4 mb-3">
          <div class="card text-center p-3">
            <h6>${p.sub_bab}</h6>
            <small class="text-muted">${p.total} Soal</small>
            <button class="btn btn-success mt-2"
              onclick="startQuiz('${p.sub_bab}')">
              Mulai
            </button>
          </div>
        </div>
      `;
    });
  })
  .catch(err => {
    console.error("FETCH ERROR:", err);
  });


function startQuiz(sub){
  currentSubBab = sub; 
  document.getElementById("menuQuiz").style.display = "none";
  document.getElementById("quizPage").style.display = "block";

  quizTitle.innerText = sub;
  index = 0;
  answers = [];
  time = 60;
  quizFinished = false;

  fetch("../api/quiz_start.php?sub=" + encodeURIComponent(sub))
    .then(res => {
      if(!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    })
    .then(data => {
      console.log("SOAL DARI API:", data);

      if (!data || data.length === 0) {
        alert("Soal untuk sub ini belum ada");
        location.reload();
        return;
      }

      questions = data;
      renderQuestionList();
      loadQuestion();
      startTimer();
    })
    .catch(err => {
      console.error("ERROR AMBIL SOAL:", err);
    });
}

/* ================= TIMER ================= */
function startTimer(){
  clearInterval(timer);
  updateTime();

  timer=setInterval(()=>{
    time--;
    updateTime();

    if(time<=0){
      clearInterval(timer);
      finishQuiz(true);
    }
  },1000);
}

function updateTime(){
  const min=String(Math.floor(time/60)).padStart(2,'0');
  const sec=String(time%60).padStart(2,'0');
  timeLeft.innerText=`${min}:${sec}`;
}

/* ================= QUIZ ================= */
function loadQuestion(){
  const q = questions[index];

  questionText.innerText = q.q;
  questionCount.innerText = `Soal ${index+1} / ${questions.length}`;

  options.innerHTML = '';

  q.options.forEach((opt,i)=>{
    const div = document.createElement('div');
    div.className = 'option';
    div.innerText = opt;
    if(answers[index] === i) div.classList.add('active');
    div.onclick = () => selectOption(i, div);
    options.appendChild(div);
  });

  // UBAH TEKS BUTTON SAJA
  nextBtn.innerText =
    index === questions.length - 1 ? 'Submit' : 'Next';

  updateProgress();
  highlightQuestion();
}


function selectOption(i,el){
  answers[index]=i;
  document.querySelectorAll('.option').forEach(o=>o.classList.remove('active'));
  el.classList.add('active');
}

function nextQuestion(){
  if(answers[index] === undefined){
    alert('Pilih jawaban dulu');
    return;
  }

  if(index === questions.length - 1){
    finishQuiz();
  }else{
    index++;
    loadQuestion();
  }
}

function prevQuestion(){
  if(index>0){
    index--;
    loadQuestion();
  }
}

/* ================= UI ================= */
function renderQuestionList(){
  questionList.innerHTML='';
  questions.forEach((_,i)=>{
    const div=document.createElement('div');
    div.innerText='Question '+(i+1);
    questionList.appendChild(div);
  });
}

function highlightQuestion(){
  document.querySelectorAll('.question-list div').forEach((d,i)=>{
    d.className='';
    if(answers[i]!==undefined) d.classList.add('done');
    if(i===index) d.classList.add('active');
  });
}

function updateProgress(){
  const answered=answers.filter(a=>a!==undefined).length;
  progressBar.style.width=(answered/questions.length*100)+'%';

  const correct=answers.filter((a,i)=>a===questions[i].answer).length;
  scorePercent.innerText=Math.round(correct/questions.length*100)+'%';
}

/* ================= FINISH ================= */
function finishQuiz(){
  console.log("QUESTIONS:", questions);
  console.log("ANSWERS:", answers);
  if (!questions || questions.length === 0) {
    alert("Soal belum termuat");
    return;
  }

  let benar = 0;

  questions.forEach((q, i) => {
    if (answers[i] === q.answer) benar++;
  });

  const nilai = Math.round((benar / questions.length) * 100);


  if (!currentSubBab) {
  alert("Sub bab belum terpilih");
  return;
}

fetch("../api/nilai_simpan.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    siswa_id: 1,
    sub_bab: currentSubBab,
    nilai: nilai
  })
})
.then(r => {
  console.log("STATUS HTTP:", r.status);
  return r.text(); // ‚ö†Ô∏è sementara TEXT dulu
})
.then(t => {
  console.log("RESPON SERVER:", t);
  const res = JSON.parse(t);

  if(res.status === "OK"){
    showSummary(); // ‚¨ÖÔ∏è PENTING
  }else{
    alert(res.msg);
  }
})

.catch(err => {
  console.error("FETCH ERROR:", err);
  alert("Terjadi kesalahan koneksi");
});

}

function showSummary(){
  quizPage.style.display='none';
  summaryPage.style.display='flex';

  const total = questions.length;
  let correct = 0;

  questions.forEach((q,i)=>{
    if(answers[i] === q.answer) correct++;
  });

  const wrong = total - correct;
  const score = correct * 10; // 1 soal = 10 poin (bebas)

  sumTotal.innerText = total;
  sumCorrect.innerText = correct;
  sumWrong.innerText = wrong;
  sumScore.innerText = score;
}

function openAnswerKey(){
  summaryPage.style.display='none';
  answerKeyPage.style.display='flex';

  renderAnswerKey();
}

function backToSummary(){
  answerKeyPage.style.display='none';
  summaryPage.style.display='flex';
}

function renderAnswerKey(){
  answerKeyList.innerHTML='';

  const total = questions.length;
  let correct = 0;

  questions.forEach((q,i)=>{
    const userAnswer = answers[i];
    const isCorrect = userAnswer === q.answer;
    if(isCorrect) correct++;

    const div = document.createElement('div');
    div.className = `answer-item ${isCorrect ? 'correct' : 'wrong'}`;

    div.innerHTML = `
      <strong>Soal ${i+1}</strong>
      <div>Jawaban kamu: <b>${q.options[userAnswer] ?? '-'}</b></div>
      <div>Kunci jawaban: <b>${q.options[q.answer]}</b></div>
    `;

    answerKeyList.appendChild(div);
  });

  const correctPercent = Math.round(correct / total * 100);
  const wrongPercent = 100 - correctPercent;

  xpCorrect.style.width = correctPercent + '%';
  xpWrong.style.width = wrongPercent + '%';

  xpCorrectText.innerText = correctPercent + '%';
  xpWrongText.innerText = wrongPercent + '%';
}

document.querySelectorAll('.navlink').forEach(el=>{
      el.addEventListener('click', ()=> {
        document.querySelectorAll('.navlink').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
        // optional: scroll internal panels or focus by id if implemented
        const target = el.dataset.target;
        if(target){
          // highlight corresponding panel briefly (if present)
          const panel = document.getElementById(target);
          if(panel){
            panel.style.boxShadow = '0 12px 40px rgba(109,151,115,0.12)';
            setTimeout(()=> panel.style.boxShadow = '0 8px 22px rgba(12,59,46,0.03)', 900);
          }
        }
      });
    });
</script>
</body>
</html>